# lottery
## 射雕英雄传手游庆功宴抽奖

***
## 原理解密
### 本抽奖系统为什么安全
首先，抽奖机制的逻辑是单独处理的，无论其它模块发生了什么（即使出错），抽奖机制本身不受影响。

抽奖机制主要由两部分组成，一是 `乱序重排（reorder）` ，二是 `随机取样（sample）` 。另外有一个作为辅助的 `计时器（timer）`。

乱序重排：
    这部分根据一个随机生成的，极为复杂的全局种子，对原参与者名单进行乱序。这个种子长度为256，不可读，无语义，每次打开本系统都会变化。
    假定有两份该系统副本，同时在同一刻打开，这个种子也不相同，这保证了名单排序的不可预测。

随机取样：
    这部分上文乱序后名单的基础上，以时间戳为随机种子，进行随机抽选，直到满足名额或没有剩余未中奖者。
    假定有一套该系统副本，在两个不同的时刻分别抽奖，由于时间戳不同，取样结果不同，这保证了抽奖结果的不可预测。
    而取样结果，也就是中奖者名单，将从参与者名单中划除。这保证了，同一线上系统，同一套抽奖中，不会出现重复中奖者。

乱序重排与随机取样，从随机概率的角度是冗余的，两次随机没有意义：
    但由于乱序重排可以由系统伪造（比如我把种子写死在代码里），但随机取样的时间戳现场才知道，喊停者能决定，而大家都能见证，所以保证了结果的公平。
    同样，随机取样时间戳，喊停者可以决定，但由于乱序重排的种子完全随机，时间不相干，不可读不可记忆，所以任然保证了结果的公平。

计时器：
    计时器作为抽奖的辅助模块，由滚筒与抽奖结果面板共享。抽奖时，滚筒时间驱动，抽奖结果也时间驱动，这保证了喊停时，滚筒状态与抽奖结果完全一致。
    并且这个结果不是从滚筒复制，而是由滚筒模块和结果模块同时计算得出，二者必定一致但又相互印证。

最后，根据本次现场抽奖出现的情况，我解释下抽奖中的其它细节：
    首先，对于这次出现的，某轮抽奖结果由于操作员手误而导致无效的情况，这轮抽奖被系统视为无效，因而会放回未中奖名单，不影响后续继续中奖概率。
    并且，由于抽奖结果时间驱动，而不是时间间隔更换，对于一个不可预知但一定在将来确定的喊停时刻，中间无效操作不会对结果的公平产生影响。


### 抽奖结果为什么可验证且不可伪造
可验证：
    本抽奖系统，保存结果时会同时存下一个叫做 `backup.js` 的备份脚本。该脚本记录了整个抽奖流程中的几个关键的，影响抽奖结果的操作的随机种子、操作时间、操作对象等。
    脚本内自带一个用于验证全局种子的立即执行函数闭包，如果该闭包执行通过，表明backup.js内记录的种子有效无损坏，这保证了乱序重排模块的所有结果可复现。
    对于每轮抽奖，包括重新抽取本轮，以及替换个别名单，脚本都记录了决定其结果的时间戳。这保证了随机取样模块的结果也可复现。并且本次更新后，中间取样环节也可复现了。
    计时器模块也是考虑到可验证性而设计，由于时间驱动而不是定时变更，所以记录决定结果的时间戳就做够，无需记录滚筒刷新次数和具体的每次刷新结果，降低了记录出错的可能、

不可伪造：
    首先，乱序重排用到的全局随机种子极为复杂，不可读无语义，256字长中任意一个字符变动都会无法通过验证全局种子的立即执行的函数闭包，保证了种子不可修改，无可伪造。
    随机取样结果相干与时间戳，每次喊停的时间，现场可以认定。（不过本次抽奖似乎并没有给大家认定时间戳，嘛，毕竟也没必要做到这一步吧）。所以这个时间戳不可修改，不可伪造。
    当然了，最主要的不可伪造的原因其实是，随机概率这东西太难认为干预，想要偷偷修改其中一两个关键点，却让复现结果与现场看起来差别不大至少不被看出，是无限近似不可能的。。。

### 最后，无论机制多安全，代码如果悄悄被修改了都没意义
要防止这一点，我觉得至少需要两个措施，一当然是开源，代码中所有具体技术细节的实现都可考证。这一步我已经做了，本系统开源在 [GitHub](https://github.com/zhengxiaoyao0716/wanmei-lottery)。

另一个措施会影响现场抽奖环节，实现起来较困难，对于咱这抽奖应该也不必要做到这一步，但我还是提一下吧，就是副本签名：
    具体来说，即使代码开源，也不能保证现场使用的系统就与线上开源一致，更何况还有一些内部私密信息不能一起公开。这就需要对现场实际使用的副本进行签名验证。
    在抽奖开始前，这个签名应该公开给现场所有人，时候，大家可以拿这份签名，去与线上开源版本代码的签名结果像比较，印证现场使用的程序副本未被篡改。
    抽奖名单由于涉及内部信息无法公开，但由于本抽奖系统其实无干名单的具体信息，可以用一份对关键信息“打码”后的等价数据代替，用以让大家验证。

***
## 配置
### 参考 `配置` 目录下， [射雕英雄传的配置](./配置/射雕英雄传庆功宴.js)

***
## 需求
### 抽取人数少但名称较长
由于宽度超过而纵向排列，会出现滚动条，应该去掉

### 抽取人数过多时
这个滚动条可以设置成自动滚屏吗
人工去下拉有点low


### 特殊抽奖回合
@陈正 我们在对需求的时候发现一个问题，原定五等奖是抽奖箱抽，现在池总来发这个阳光普照奖，这个奖是人均一份，按照现在的抽奖逻辑抽取之后的就不会在下个阶段的奖项里面出现了，但是后面的非阳光普照奖还是需要他们可以继续参与，有没有办法来平衡这种现象
> 我整理一下啊，第一段是说，需求某个特定的回合，其中抽奖来源名单为全体而不是去掉幸运儿后的。并且抽奖结果也不作为幸运儿从名单中去除，也就是以后还参与其它轮抽奖，对吗？

阳光普照奖是京东卡，面值也不一样 50元的100张  100元50张  200元10张 500元10张 200元是20张

> ok，那么最后整理一下，新需求是：
打包两套抽奖系统，一个是 `庆功宴抽奖`，176人，一个是 `阳光普照` ，176-20人，
阳光普照共4轮，分别是 50元 100人， 100元 50 人， 200 元 20人 500 元 10人
这样？

> 奖品=人数=156   50元100张 100元 30张  200元 20张  500元6张


### 抽中的人没来的处理
点击名称替换


### 按键绑定
空格 -> start&stop
左右箭头 -> 上下轮
回车 -> 保存


### 预期效果
噗 类似这样 的意思

![预期效果](./.request/预期效果.png)

可以放游戏主宣图

### 时间估算
这周吧？下周一测试可以用就行


### 其它要求
然后希望是可以编辑的

后面可以拿这个套用别的 

比如换个素材 换个人员池子的


***
## 高级配置
### 美术资源（./static/image）

|路径|描述|
|--|--|
|bgi.jpg|背景图|
|pendant/cg.png|主宣图|
|pendant/logo.png|logo|
|pendant/恭喜中奖.png| `恭喜中奖` 字样|
> 以上只是几个例子，具体怎么摆放摆哪些挂件(pendant) 可以自定义和扩展

### 数据与流程配置

[抽奖回合](./../static/script/config.es6#73)

[数据集](./../static/script/config.es6#80)


### 界面样式配置
[挂件](./../static/script/config.es6#13)

[控制器](./../static/script/config.es6#43)

[抽奖台](./../static/script/config.es6#51)

[滚筒区域](./../static/script/config.es6#62)
